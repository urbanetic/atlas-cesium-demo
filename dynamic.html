<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>atlas-cesium demo</title>
  <link rel="stylesheet" href="./atlas-cesium/lib/cesium/Source/Widgets/Viewer/Viewer.css">
  <link rel="stylesheet" href="atlas/css/atlas.css">
  <!--link rel="stylesheet" href="./atlas/css/Atlas.css"-->
  <script src="atlas/lib/require.js"></script>
  <script>
    "use strict";
    var cesiumAtlas;

    console.debug('Requiring CesiumAtlas');
    require.config({
      baseUrl: '',
      packages: [
        { name: 'atlas/lib', location: 'atlas/lib'},
        { name: 'atlas/assets', location: 'atlas/assets'}, // Only need this for testing
        { name: 'atlas', location: 'atlas/src'},
        { name: 'atlas-cesium/cesium', location: 'atlas-cesium/lib/cesium'},
        { name: 'atlas-cesium/lib', location: 'atlas-cesium/lib'},
        { name: 'atlas-cesium', location: 'atlas-cesium/src'}
      ]/*,
      paths: [
        { name: 'atlas/lib', location: 'atlas/lib'},
        { name: 'atlas/assets', location: 'atlas/assets'}, // Only need this for testing
        { name: 'atlas-cesium/cesium', location: 'atlas-cesium/lib/cesium'},
        { name: 'atlas-cesium/lib', location: 'atlas-cesium/lib'},
      ] */
    });
    require(['atlas-cesium/core/CesiumAtlas',
               'atlas/assets/testWKT',
               'atlas/assets/testMesh2',
               'atlas/model/Colour'
               //'atlas/assets/PrahranModel',
               //'atlas/assets/LargePrahranModel'
    ], function (CesiumAtlas, testWKT, testMesh, Colour, prahranModel, largePrahranModel) {
      console.debug('Creating atlas-cesium');
      cesiumAtlas = new CesiumAtlas();

      console.debug('Attaching atlas-cesium');
      cesiumAtlas.attachTo('cesium');

      var i = 0;
      var args = {};
      args.id = 0;
      args.elevation = 0;
      args.height = 50;
      args.show = true;
      // Show many polygons
      testWKT.forEach(function (wkt) {
        args.id = i++;
        args.footprint = wkt;//testWKT[0];//
        cesiumAtlas.publish('entity/show', args);
      });

      // Show the Prahran model
//      args.features = largePrahranModel;
//      cesiumAtlas.publish('entity/bulk/show', args);

      // Test mesh
      args.id = 100;
      args.displayMode = 'mesh';
      delete args.footprint;
      args.mesh = testMesh;
      cesiumAtlas.publish('entity/show', args);

      // Test zoomTo
      setTimeout( (function () {
        console.debug('fired camera/zoomTo event');
        this._managers.render._widget.resize();
        this._managers.render._widget.render();
        this.publish('camera/zoomTo', {
          position: {
            lat: -37.8,
            lng: 144.96,
            elevation: 2000
          },
          duration: 0
        })
      }).bind(cesiumAtlas), 1000);

      // -------------------------------------------
      // Test static projection (hard coded).
      // -------------------------------------------
//      setTimeout( function () {
//        var values = {};
//        var vis = cesiumAtlas._managers.visualisation;
//        setInterval(function () {
//          [0,1,2,3,4,5,6].forEach(function (i) {
//            values[i] = Math.random() * 100 + Math.random() * 1000;
//          });
//          //cesiumAtlas._managers.visualisation._testHeight(values);
//          cesiumAtlas._managers.visualisation._testColour(values);
//        }.bind(cesiumAtlas), 10);
//      }.bind(cesiumAtlas), 6000);


      // -------------------------------------------
      // Test static projection (using publish).
      // -------------------------------------------
//      setTimeout(function () {
//        var ids = [0, 1, 2, 3, 4, 5, 6],
//            config = {},
//            values = [];
//        ids.forEach(function (i) {
//          values[i] = Math.random() * 100 + Math.random() * 1000;
//        });
//        config = {
//          values: values,
//          codomain: {startProj: Colour.BLUE, endProj: Colour.GREEN}
//        };
//        cesiumAtlas.publish('projection/add', {type: 'colour', ids: ids, config: config});
//        //cesiumAtlas.publish('projection/render', 'colour');
//      }.bind(cesiumAtlas), 6000);

      // -------------------------------------------
      // Test dynamic projection (using publish).
      // -------------------------------------------
      setTimeout(function () {
        // For the dynamic projection, the 'static' projection used
        var ids = [0, 1, 2, 3, 4, 5, 6, 100],
            data = [
              {index: 1, values: {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 100: 5}},
              {index: 2, values: {0: 1, 1: 1, 2: 1, 3: 1, 4: 1, 5: 1, 6: 1, 100: 4}},
              {index: 3, values: {0: 2, 1: 2, 2: 2, 3: 2, 4: 2, 5: 2, 6: 2, 100: 3}},
              {index: 4, values: {0: 3, 1: 3, 2: 3, 3: 3, 4: 3, 5: 3, 6: 3, 100: 2}},
              {index: 5, values: {0: 4, 1: 4, 2: 4, 3: 4, 4: 4, 5: 4, 6: 4, 100: 1}},
              {index: 6, values: {0: 5, 1: 5, 2: 5, 3: 5, 4: 5, 5: 5, 6: 5, 100: 0}},
              {index: 7}
            ],
            codomain = {startProj: Colour.BLUE, endProj: Colour.RED},
            config = {
              bins: {numBins: 5, firstValue: 0, lastValue: 5},
              codomain: codomain,
              type: 'discrete'
            };
        this.publish('projection/dynamic/add', {
          type: 'colour', ids: ids, data: data, config: config, fps: 1, delta: 1
        });
      }.bind(cesiumAtlas), 10000)

    });
  </script>
</head>
<body>
  <div id="cesium" class="atlas"></div>
</body>
</html>
